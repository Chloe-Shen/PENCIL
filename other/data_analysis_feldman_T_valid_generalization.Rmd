---
title: "Downstream analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
path="E:\\Myfolder\\学习竞赛\\研究生\\课题项目\\singlecell-rej\\LWR\\code\\datasets\\Feldman_T_cell"
knitr::opts_knit$set(root.dir = path)
```

```{r}
library(Seurat)
library(ggplot2)
library(dplyr)
library(scales)

library(reticulate)
# use_python("/usr/bin/python", required = T) #set python environment
# py_config()

## Load SeuratObject
rm(list=ls())
require(Seurat)
require(data.table)
library(openxlsx)

# It seems that the change only work for this block? 
# setwd("./") 
setwd("E:\\Myfolder\\学习竞赛\\研究生\\课题项目\\singlecell-rej\\LWR\\code\\datasets\\Feldman_T_cell")

dataname <-  'feldmanT-valid'
expr_id <- 'RNR-8000MVGs'
# data_path <- sprintf('./datasets/%s/', dataname)
data_path <- './'

result_path <- sprintf('./results/%s/R/%s/', dataname, expr_id)
dir.create(result_path, recursive = T)

load('./Feldman_T_cell_Seurat_object.RData')
pbmc.new <- readRDS('./CD8_pbmc_final.rds')
pbmc.new <- UpdateSeuratObject(pbmc.new)


DimPlot(pbmc.new, group.by = 'orig.ident')
```

## filter data
```{r}
common_genes <- intersect(rownames(pbmc), rownames(pbmc.new))

dim(pbmc)
dim(pbmc.new)
length(common_genes)

common_genes <- intersect(rownames(pbmc), rownames(pbmc.new))
pbmc <- pbmc[common_genes, ]
pbmc.new <- pbmc.new[common_genes, ]

pbmc$source <- rep('origin', dim(pbmc)[2])
pbmc.new$source <- rep('new', dim(pbmc.new)[2])


pbmc <- NormalizeData(object=pbmc, normalization.method="LogNormalize")
pbmc.new <- NormalizeData(object=pbmc.new, normalization.method="LogNormalize")

pbmc$Conditions <- pbmc$responsive_status
DimPlot(object=pbmc, reduction='umap', label=F, group.by='Conditions')


responder_sample_ids = c("11025-26_progression", "11025-57", "11025-58")
Conditions <- rep('Non-responder', dim(pbmc.new)[2])
Conditions[pbmc.new$orig.ident %in% responder_sample_ids] <- 'Responder'
pbmc.new <- AddMetaData(pbmc.new, metadata = Conditions, col.name = 'Conditions')    
DimPlot(object=pbmc.new, reduction='umap', label=F, group.by='Conditions')

# pbmc_ <- pbmc.new
# pbmc.new <- pbmc
# pbmc <- pbmc_


# pbmc.merge <-merge(pbmc, pbmc.new)
# dim(pbmc.merge)
# 
# pbmc.merge <- FindVariableFeatures(object=pbmc.merge, selection.method='vst', nfeatures=2000)
# pbmc.merge <- ScaleData(object=pbmc.merge)
# #
# pbmc.merge <- RunPCA(object=pbmc.merge, features=VariableFeatures(pbmc.merge))
# pbmc.merge <- FindNeighbors(object=pbmc.merge, dims=1:10, k.param=20)
# pbmc.merge <- FindClusters(object=pbmc.merge, resolution=1.6)
# #data <- RunTSNE(object=data, dims=1:10)
# pbmc.merge <- RunUMAP(object=pbmc.merge, dims=1:10)
# 
# pbmc.merge$Conditions <-pbmc.merge$responsive_status
# DimPlot(object=pbmc.new, reduction='umap', label=F, group.by='Conditions')
# DimPlot(object=pbmc.merge, reduction='umap', label=T, group.by = 'source')

```



## load paper cells' information and caculate umap
```{r}
# paper_Fig2_anno_file = './mmc2.xlsx'
# paper_CD8_good_bad = read.xlsx(paper_Fig2_anno_file, sheet=3)
#
# row.names(paper_CD8_good_bad) = paper_CD8_good_bad$Cell.Name
# colnames(paper_CD8_good_bad) <- c('cell.name', 'paper.good.bad')
# pbmc <- AddMetaData(pbmc, metadata = paper_CD8_good_bad)
#
#
# pbmc <- CreateSeuratObject(counts = pbmc@assays[["RNA"]]@counts, meta.data = pbmc@meta.data)
pbmc <- NormalizeData(object=pbmc, normalization.method="LogNormalize")
pbmc <- FindVariableFeatures(object=pbmc, selection.method='vst', nfeatures=8000)
pbmc <- ScaleData(object=pbmc)
#
pbmc <- RunPCA(object=pbmc, features=VariableFeatures(pbmc))
pbmc <- FindNeighbors(object=pbmc, dims=1:10, k.param=20)
pbmc <- FindClusters(object=pbmc, resolution=1.6)
#data <- RunTSNE(object=data, dims=1:10)
pbmc <- RunUMAP(object=pbmc, dims=1:10)

# pbmc$Conditions <-pbmc$responsive_status
DimPlot(object=pbmc, reduction='umap', label=F, group.by='Conditions')
DimPlot(object=pbmc, reduction='umap', label=T, label.size=10)

# save(pbmc, file='./Feldman_T_cell_Seurat_object.RData')
```

```{r}
DimPlot(object=pbmc, reduction='umap', label=F, group.by='Conditions', pt.size = 1)
DimPlot(object=pbmc, reduction='umap', label=F, pt.size=1)
```

## Generated exp_data and labels 
```{r}
filepath = data_path

conditions = pbmc@meta.data[["Conditions"]]
class_names <- as.character(unique(conditions))

# exp_data = pbmc@assays[["RNA"]]@scale.data[VariableFeatures(pbmc),]
# exp_data.raw = pbmc@assays[["RNA"]]@scale.data[VariableFeatures(pbmc),]

exp_data = as.matrix(pbmc@assays[["RNA"]]@data[VariableFeatures(pbmc),])
exp_data_scale_t = scale(t(exp_data))
center <- attr(exp_data_scale_t, "scaled:center")
scale <- attr(exp_data_scale_t,"scaled:scale")
exp_data <- t(exp_data_scale_t)

write.csv(exp_data, file=paste(filepath, 'exp_data_common_genes.csv', sep = ''))

labels <- conditions
labels = as.matrix(labels)
row.names(labels) = colnames(exp_data)
write.csv(labels, file=paste(filepath, 'label_info.csv', sep = ''))

emd = pbmc@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste(filepath, 'embedding-umap.csv', sep = ''))

print(class_names)
table(labels)
```
# ```{r}
# minus =  exp_data.raw - exp_data
# 
# minus[abs(minus) < 0.001] <- 0
# ```


```{python}
import os 
os.environ['CUDA_VISIBLE_DEVICES'] = '0' 

from pencil import *
from copy import deepcopy

torch.cuda.device_count()

data_name = r.dataname
class_names = r.class_names
# class_names = None 
exp_file ='%s/exp_data.csv' % (r.data_path)
anno_file ='%s/label_info.csv' % (r.data_path)
expr_id = r.expr_id #This will be included in the output-file. Anything else can be recorded here. 
embedding_name = 'embedding-umap'
embedding_file = '%s/%s.csv' % (r.data_path, embedding_name)

class_weights = None
class_weights = [2.0, 1.0]
# class_weights = [1.0, 1.0, 3.0, 1.5, 1.5]

data = deepcopy(r.exp_data.T)
# labels = label_encoder(r.labels.reshape(-1), class_names)
_, labels = load_real_data(exp_file=None, anno_file=anno_file, class_names=class_names)
# mode = 'regression'
mode = 'multi-classification'
pencil = Pencil(mode, select_genes=True, seed=1234, data_name=data_name, expr_id=expr_id, model_types=['linear', 'non-linear'])

# mlflow.end_run()
mlflow.start_run()
pred, confidence = pencil.fit_transform(
    data, labels, 
    test=True, 
    c=None,
    shuffle_rate=1/3,
    lambda_L1=1e-4, 
    lambda_L2=1e-3, 
    lr=0.01,  
    epochs=500, 
    pre_train_epochs=500,
    class_weights=class_weights,
    class_names=class_names, 
    anno_file=anno_file, 
    # embedding_name=embedding_name,
    embedding_file=embedding_file,
    plot_show=True,
    savefig=True
    )
# pred = torch.argmax(torch.Tensor(pred), 1).numpy()

w = pencil.gene_weights(plot=True, savefig=True)
plt.close()
mlflow.end_run()
```


# Add the prediction result
```{r}
DimPlot(object=pbmc, reduction='umap', label=T, group.by="Conditions")

pred_labels <- class_names[(py$pred+1)]

# pred_labels <- factor(pred_labels, levels = c('Rejected', class_names))

pred_labels[py$confidence < 0] = 'Rejected'

pred_labels_names = c('Rejected', as.character(class_names))
pred_labels <- factor(pred_labels, levels = pred_labels_names)

pred_labels <- as.data.frame(pred_labels, row.names=colnames(pbmc))

pbmc <- AddMetaData(pbmc, metadata = pred_labels, col.name='pred_labels' )
pal = c('gray', hue_pal()(length(class_names)))

DimPlot(object=pbmc, reduction='umap', label=T, group.by="pred_labels", cols = pal, pt.size = 1)
ggsave(paste(result_path, 'pencil_predict_labels.pdf'), width = 8, height = 5)

confidence <- as.data.frame(py$confidence, row.names=colnames(pbmc))
pbmc <- AddMetaData(pbmc, metadata = confidence, col.name='confidence.score' )
FeaturePlot(pbmc, features = 'confidence.score')
ggsave(paste(result_path, 'confidence.score.pdf'), width = 8, height = 5)

# FeaturePlot(pbmc, features = 'confidence.score', reduction='tsne')
# ggsave(paste(result_path, 'confidence.score-tsne.pdf'), width = 8, height = 5)
# select_genes = VariableFeatures(pbmc)[abs(py$w) > 1.0]
# FeaturePlot(pbmc, features = select_genes)

pencil_weights_of_mvg2000 <- py$w
save(pbmc, pencil_weights_of_mvg2000, file= paste(result_path, 'Seurat_object_with_results.RData', sep=''))

table(labels)
table(pbmc$pred_labels)
```
### gene weights
```{r}
genes.old = VariableFeatures(pbmc)
# genes = gsub(".+[-]", "", genes.old)
# genes = sub("([a-z|A-Z|0-9]*-)?", "", genes.old)
genes <- genes.old


gene_weights <- data.frame(gene=genes, weight=py$w, genes.old=genes.old)
gene_weights <- gene_weights[order(abs(gene_weights$weight), decreasing = TRUE), ]
rownames(gene_weights) = 1:dim(gene_weights)[1]

write.csv(gene_weights, file = paste(result_path, 'gene_weights.csv'))

num_genes_to_plot = 30
DoHeatmap(pbmc[, colnames(pbmc)[pbmc$confidence.score>0]], features = gene_weights$genes.old[1:num_genes_to_plot], group.by = 'Conditions', label=F) + scale_y_discrete(labels=rev(gene_weights$gene[1:num_genes_to_plot]))
ggsave(paste(result_path, 'heatmap_selected_cells_and_genes.png'), width = 10, height = 7)
```

### selected genes
```{r}
select_genes = VariableFeatures(pbmc)[abs(py$w) > 1]
pbmc_small.3 <- pbmc[select_genes, ]

pbmc_small.3 <- RunPCA(object=pbmc_small.3, features=rownames(pbmc_small.3), npcs=30)
ElbowPlot(pbmc_small.3, 30)


pbmc_small.3 <- FindNeighbors(object=pbmc_small.3, dims=1:10, k.param=20)
pbmc_small.3 <- FindClusters(object=pbmc_small.3, resolution=0.8)

# data <- RunTSNE(object=data, dims=1:10)
pbmc_small.3 <- RunUMAP(object=pbmc_small.3, dims=1:10)
# pbmc_small.3 <- RunUMAP(object=pbmc_small.3, features = select_genes)
# pbmc_small.2 <- RunTSNE(object=pbmc_small.2, dims=1:15)

A = DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="Conditions")
pal = c('gray', hue_pal()(length(class_names)))
B = DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="pred_labels", cols=pal, order = rev(levels(pbmc_small.3$pred_labels)))
C = DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="seurat_clusters")
D = FeaturePlot(pbmc_small.3, features = 'confidence.score', reduction='umap')

(A+B) / (C+D)
ggsave(paste(result_path, 'selected_genes.pdf'), width = 15, height = 12)

DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="pred_labels", cols=pal, order = rev(levels(pbmc_small.3$pred_labels)), pt.size = 1)
ggsave(paste(result_path, 'selected_genes_with_rej_cells.pdf'), width = 7, height = 7)

DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="Conditions", cells=colnames(pbmc)[pbmc$confidence.score>0], pt.size = 1)
ggsave(paste(result_path, 'selected_genes_without_rej_cells.pdf'), width = 7, height = 7)

# DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="original_clustering")
# DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="orig.ident")
```


### selected cells
```{r}
pbmc_small <- pbmc[VariableFeatures(pbmc),colnames(pbmc)[pbmc$confidence.score>0]]
# genes = gsub(".+[-]", "", VariableFeatures(pbmc))

# pbmc <- NormalizeData(object=pbmc_small, normalization.method="LogNormalize")
# pbmc <- FindVariableFeatures(object=pbmc, selection.method='vst', nfeatures=2000)
# pbmc <- ScaleData(object=pbmc)
#
pbmc_small <- RunPCA(object=pbmc_small, features=rownames(pbmc_small), npcs=30)
ElbowPlot(pbmc, 30)

pbmc_small <- FindNeighbors(object=pbmc_small, dims=1:10, k.param=20)
pbmc_small <- FindClusters(object=pbmc_small, resolution=0.8)

# data <- RunTSNE(object=data, dims=1:10)
pbmc_small <- RunUMAP(object=pbmc_small, dims=1:10)
A = DimPlot(object=pbmc_small, reduction='umap', label=T, group.by="Conditions")
B = DimPlot(object=pbmc_small, reduction='umap', label=T, group.by="pred_labels") 
C = DimPlot(object=pbmc_small, reduction='umap', label=T, group.by="seurat_clusters")

D = FeaturePlot(pbmc_small, features = 'confidence.score', reduction='umap')

(A+B) / (C+D)
ggsave(paste(result_path, 'selected_cells.pdf'), width = 15, height = 12)


# select_genes = VariableFeatures(pbmc)[abs(py$w) > 4.0]
# FeaturePlot(pbmc_small, features = select_genes)

# n_genes_select = 10
# p1 = DotPlot(pbmc, features = gene_weights$genes.old[1:n_genes_select], group.by = 'Conditions') + scale_x_discrete(labels=gene_weights$gene[1:n_genes_select])
# p2 = DotPlot(pbmc_small, features = gene_weights$genes.old[1:n_genes_select], group.by = "pred_labels") + scale_x_discrete(labels=gene_weights$gene[1:n_genes_select])
# p1 / p2
# ggsave(paste(result_path, 'dotplot_before_vs_after.pdf'), width = 15, height = 10)
# # print(p1)
# # print(p2)


```




### selected cells and selected genes
```{r}
select_genes = VariableFeatures(pbmc)[abs(py$w) > 1.0]
pbmc_small.2 <- pbmc[select_genes, colnames(pbmc)[pbmc$confidence.score>0]]

pbmc_small.2 <- RunPCA(object=pbmc_small.2, features=rownames(pbmc_small.2), npcs=30)
ElbowPlot(pbmc_small.2, 30)

pbmc_small.2 <- FindNeighbors(object=pbmc_small.2, dims=1:20, k.param=20)
pbmc_small.2 <- FindClusters(object=pbmc_small.2, resolution=0.8)

# data <- RunTSNE(object=data, dims=1:10)
pbmc_small.2 <- RunUMAP(object=pbmc_small.2, dims=1:20)
# pbmc_small.2 <- RunTSNE(object=pbmc_small.2, dims=1:15)

A = DimPlot(object=pbmc_small.2, reduction='umap', label=T, group.by="Conditions")
B = DimPlot(object=pbmc_small.2, reduction='umap', label=T, group.by="pred_labels")
C = DimPlot(object=pbmc_small.2, reduction='umap', label=T, group.by="seurat_clusters")
D = FeaturePlot(pbmc_small.2, features = 'confidence.score', reduction='umap')

(A+B) / (C+D)
ggsave(paste(result_path, 'selected_cells_and_genes.pdf'), width = 15, height = 12)

# DimPlot(object=pbmc_small.2, reduction='tsne', label=T, group.by="Conditions")
# DimPlot(object=pbmc_small.2, reduction='tsne', label=T, group.by="pred_labels")
# DimPlot(object=pbmc_small.2, reduction='tsne', label=T, group.by="seurat_clusters")
# ggsave(paste(result_path, 'selected_cells_and_genes-tsne.pdf'), width = 15, height = 5)

# FeaturePlot(pbmc_small.2, features = gene_weights$genes.old[1:12])
# ggsave(paste(result_path, 'top12genes_selected_cells_and_genes.pdf'), width = 25, height = 25)
# FeaturePlot(pbmc_small.2, features = gene_weights$genes.old[1:12], reduction = 'tsne')
# ggsave(paste(result_path, 'top12genes_selected_cells_and_genes-tsne.pdf'), width = 25, height = 25)
```
# Heatmap for comparing with paper_good_bad cells
```{r}
library(openxlsx)
library(tibble)
library(pheatmap)
save_pheatmap_pdf <- function(x, filename, width=7, height=7) {
   stopifnot(!missing(x))
   stopifnot(!missing(filename))
   pdf(filename, width=width, height=height)
   grid::grid.newpage()
   grid::grid.draw(x$gtable)
   dev.off()
}


exp = pbmc@assays$RNA@data
exp = as.matrix(exp)

# paper_Fig2_anno_file = 'D:/Myfolder/学习竞赛/研究生/课题项目/singlecell-rej/LWR/code/datasets/Feldman_T_cell/mmc2.xlsx'
# paper_CD8_good_bad = read.xlsx(paper_Fig2_anno_file, sheet=3)
# 
# rownames(paper_CD8_good_bad) = paper_CD8_good_bad$Cell.Name
# 
# setdiff(paper_CD8_good_bad$Cell.Name, colnames(pbmc))

selected_genes = c('TCF7','IL7R','CD38',"EPSTI1","WARS","CCL3","VCAM1","LGALS1","PSMA4","SNAP47","GBP1","FASLG", "IFI6","MX1","HOPX","PSMB2","PRDX3","SERPINB1","NDUFB3","MT2A","GBP4","ANXA5")

# selected_genes = c('TCF7','IL7R', "MALAT1","GAPDH","RP5-940J5.9","ACTB","PRF1","NKG7","CD38","PFN1","PSME2","RP11-274E7.2","IFI6","PSME2P2","ACTG1","GZMA","UBE2L6","PSMB9","CD74","LINC00152","GBP5","HLA-DPA1","CALM3")

#setdiff(selected_genes,rownames(exp))

exp_for_heatmap = exp[selected_genes, ]
exp_for_heatmap_scale = t(scale(t(exp_for_heatmap)))

up_genes = c('TCF7',"IL7R")
down_genes = setdiff(selected_genes, up_genes)
diff_mean_exp_between_up_and_down_genes = colMeans(exp_for_heatmap_scale[up_genes, ]) - colMeans(exp_for_heatmap_scale[down_genes, ])

# pbmc$responsive_status <- pbmc$Conditions

pbmc$predict_lables_rejected_type_meta2 <- as.character(pbmc$pred_labels)
pbmc$predict_lables_rejected_type_meta2[pbmc$pred_labels=='Rejected' & pbmc$responsive_status=='Responder'] <- "Rejected_Responder"
pbmc$predict_lables_rejected_type_meta2[pbmc$pred_labels=='Rejected' & pbmc$responsive_status=='Non-responder'] <- "Rejected_Non_responder"
pbmc$predict_lables_rejected_type_meta2 <- factor(pbmc$predict_lables_rejected_type_meta2)

annotation_col_all=data.frame(
  cellids=colnames(pbmc), 
  responsive=factor(pbmc$responsive_status),
  prediction=factor(pbmc$predict_lables_rejected_type_meta2),
  diff_val=diff_mean_exp_between_up_and_down_genes,
  # paper_good_bad=paper_CD8_good_bad[colnames(pbmc),2]
  paper_good_bad=pbmc$paper.good.bad
)

# dim(annotation_col_all)
annotation_col_all = annotation_col_all %>% arrange(factor(responsive, levels=c("Responder","Non-responder")), desc(diff_val), group.by=responsive)
# annotation_col = annotation_col_all %>% column_to_rownames(var="cellids") %>% select(responsive, prediction, paper_good_bad)
annotation_col = annotation_col_all %>% select(responsive, prediction, paper_good_bad)
  
#rownames(annotation_col)=annotation_col_all[,1]

ann_colors=list(
  prediction=c("Non-responder"="orange", "Rejected_Non_responder"="black","Rejected_Responder"="red","Responder"="blue"),
  responsive=c("Non-responder"="orange", "Responder"="blue"),
  paper_good_bad=c(c(CD8_B="orange", CD8_G="blue")),
  NULL
)

exp_for_heatmap = exp_for_heatmap[, annotation_col_all$cellids]

colors<-colorRampPalette(c("blue","black","yellow"))(256)
heatmap1 = pheatmap(exp_for_heatmap, annotation_col=annotation_col, show_colnames=F, annotation_colors=ann_colors, cluster_rows=F, cluster_cols=F, scale='row', gaps_col=sum(annotation_col$responsive=='Responder'), color=colors)
save_pheatmap_pdf(heatmap1, paste(result_path,  "heatmap(vs_paper_GB).pdf", sep=''))

##remove the rejected cells
cells_kept = annotation_col$prediction=="Non-responder" | annotation_col$prediction=="Responder"
exp_for_heatmap_confident = exp_for_heatmap[,cells_kept]
annotation_col_confident = annotation_col[cells_kept,]
heatmap2 = pheatmap(exp_for_heatmap_confident, annotation_col=annotation_col_confident, show_colnames=F, annotation_colors=ann_colors, cluster_rows=F, cluster_cols=F, scale='row', gaps_col=sum(annotation_col_confident$responsive=='Responder'), color=colors)
save_pheatmap_pdf(heatmap2, paste(result_path,  "heatmap_confident(vs_paper_GB).pdf", sep=''))

rm(exp)
```

# Overlap summary with paper_good_bad cells
```{r}
# save_path = 'D:/Myfolder/学习竞赛/研究生/课题项目/singlecell-rej/LWR/code/Rscripts/temp/'
save_path = result_path
cells_kept = annotation_col$prediction=="Non-responder" | annotation_col$prediction=="Responder"
annotation_col_rest = annotation_col[cells_kept, ]

annotation_col_R_rest = annotation_col_rest[annotation_col_rest$responsive=='Responder', ]
annotation_col_NR_rest = annotation_col_rest[annotation_col_rest$responsive=='Non-responder', ]

annotation_col_R = annotation_col[annotation_col$responsive=='Responder', ]
annotation_col_NR = annotation_col[annotation_col$responsive=='Non-responder', ]


annotation_col_G_in_NR = annotation_col_NR[annotation_col_NR$paper_good_bad=='CD8_G', ]
annotation_col_B_in_R = annotation_col_R[annotation_col_R$paper_good_bad=='CD8_B', ]

overlap_summary = data.frame(
  overlap_of_pre_cells_in_R = sum(annotation_col_R_rest$prediction=='Responder') / nrow(annotation_col_R_rest),
  overlap_of_pre_cells_in_NR = sum(annotation_col_NR_rest$prediction=='Non-responder') / nrow(annotation_col_NR_rest),
  overlap_of_rej_cells_in_R = sum(annotation_col_R$prediction=='Rejected_Responder') / nrow(annotation_col_R),
  overlap_of_rej_cells_in_NR = sum(annotation_col_NR$prediction=='Rejected_Non_responder') / nrow(annotation_col_NR),
  overlap_of_rej_cells_in_G_NR= sum(annotation_col_G_in_NR$prediction=='Rejected_Non_responder') / nrow(annotation_col_G_in_NR),
  overlap_of_rej_cells_in_B_R = sum(annotation_col_B_in_R$prediction=='Rejected_Responder') / nrow(annotation_col_B_in_R)
)
print(overlap_summary)
# write.csv(overlap_summary, paste(save_path, 'overlap_sumary.csv', sep=''))

num_rej_in_R = sum(annotation_col_R$prediction=='Rejected_Responder')
num_R = nrow(annotation_col_R)

num_rej_in_NR = sum(annotation_col_NR$prediction=='Rejected_Non_responder')
num_NR = nrow(annotation_col_NR)

num_rej_in_G_NR = sum(annotation_col_G_in_NR$prediction=='Rejected_Non_responder')
num_G_NR = nrow(annotation_col_G_in_NR)

num_rej_in_B_R = sum(annotation_col_B_in_R$prediction=='Rejected_Responder')
num_B_R = nrow(annotation_col_B_in_R)


overlap_of_rej = data.frame(
  R = c(num_rej_in_R, num_R - num_rej_in_R), 
  Bad_R = c(num_rej_in_B_R, num_B_R - num_rej_in_B_R),
  Good_NR = c(num_rej_in_G_NR, num_G_NR - num_rej_in_G_NR),
  NR = c(num_rej_in_NR, num_NR - num_rej_in_NR),
  row.names = c("Rejected", "Not_rejected")
)

df = data.frame(
  frequency = as.vector(t(as.matrix(overlap_of_rej))),
  type = rep(colnames(overlap_of_rej), 2),
  rejected = c(rep(c("Y"), 4), rep(c("N"), 4))
)
df$type = factor(df$type, levels=c('R','Good_NR','Bad_R','NR'))
df$rejected = factor(df$rejected, levels=c('Y','N'))
ggplot(data = df, mapping = aes(x = type, y = frequency, fill = rejected)) + geom_bar(stat = 'identity', position = 'stack', width = 0.5)
ggsave(paste(save_path,  "overlap.pdf", sep=''))
ggplot(data = df, mapping = aes(x = type, y = frequency, fill = rejected)) + geom_bar(stat = 'identity', position = 'fill', width = 0.5)
ggsave(paste(save_path,  "overlap_scale.pdf", sep=''))

```
```{r}
All_genes = rownames(pbmc)
features_for_calculation = setdiff(All_genes,All_genes[c(grep('^RPL', All_genes),grep('^RPS', All_genes),grep('\\.', All_genes),grep('^MT', All_genes))])

log2FC_cutoff = 0.2
PENCIL_R_vs_NR_DEGs = FindMarkers(pbmc, ident.1="Responder", ident.2="Non-responder",group.by = "pred_labels",logfc.threshold=log2FC_cutoff,features = features_for_calculation)
Paper_G_vs_Bd_DEGs = FindMarkers(pbmc, ident.1="CD8_G", ident.2="CD8_B",group.by = "paper.good.bad",logfc.threshold=log2FC_cutoff,features = features_for_calculation)
Patient_R_vs_NR_DEGs = FindMarkers(pbmc, ident.1="Responder", ident.2="Non-responder",group.by = "Conditions",logfc.threshold=log2FC_cutoff,features = features_for_calculation)

VlnPlot(pbmc, features=c("TOX"),group.by = "paper.good.bad")
VlnPlot(pbmc, features=c("TOX"),group.by = "pred_labels")

PENCIL_R_vs_NR_DEGs$genes <- row.names(PENCIL_R_vs_NR_DEGs)
Paper_G_vs_Bd_DEGs$genes <- row.names(Paper_G_vs_Bd_DEGs)
Patient_R_vs_NR_DEGs$genes <- row.names(Patient_R_vs_NR_DEGs)
  
##up-genes
PENCIL_up_genes = rownames(PENCIL_R_vs_NR_DEGs %>% filter(p_val_adj<0.05 & avg_log2FC>0))
Paper_G_B_up_genes = rownames(Paper_G_vs_Bd_DEGs %>% filter(p_val_adj<0.05 & avg_log2FC>0))
setdiff(PENCIL_up_genes,Paper_G_B_up_genes)
setdiff(Paper_G_B_up_genes, PENCIL_up_genes)

##Down genes
PENCIL_dn_genes = rownames(PENCIL_R_vs_NR_DEGs %>% filter(p_val_adj<0.05 & avg_log2FC<0))
Paper_G_B_dn_genes = rownames(Paper_G_vs_Bd_DEGs %>% filter(p_val_adj<0.05 & avg_log2FC<0))
setdiff(PENCIL_dn_genes,Paper_G_B_dn_genes)
setdiff(Paper_G_B_dn_genes, PENCIL_dn_genes)

save(PENCIL_R_vs_NR_DEGs, Paper_G_vs_Bd_DEGs, Patient_R_vs_NR_DEGs, file= paste(result_path, 'degs_compare.RData', sep=''))

library(VennDiagram)
library(grid)
library(cowplot)
venn.plot <- venn.diagram(
    x = list(
        "PENCIL_R_vs_NR_DEGs" = row.names(PENCIL_R_vs_NR_DEGs %>% filter(p_val_adj<0.05)),
        "Paper_G_vs_Bd_DEGs" = row.names(Paper_G_vs_Bd_DEGs %>% filter(p_val_adj<0.05)),
        "Patient_R_vs_NR_DEGs" = row.names(Patient_R_vs_NR_DEGs %>% filter(p_val_adj<0.05))
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange", 'lightgreen'),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'DEGs', ncol = 1, nrow = 1)
for (each in list.files('./')){
      if (substring(each, nchar(each)-2) == 'log'){
        file.remove(each)
      }
}
```

# markergenes
```{r}
library(VennDiagram)
library(grid)
library(cowplot)

Idents(pbmc)="Conditions"
all.markers.before <- FindAllMarkers(object = pbmc)

pbmc_selected <- pbmc[, colnames(pbmc)[pbmc$confidence.score>0]]
pbmc_selected$pred_labels <- factor(as.character(pbmc_selected$pred_labels))
Idents(pbmc_selected)='pred_labels'
all.markers.after <- FindAllMarkers(object = pbmc_selected)

venn.plot <- venn.diagram(
    x = list(
        "Selected by Pencil" = unique(all.markers.after$gene[all.markers.after$p_val_adj<0.05]),
        "Before" = unique(all.markers.before$gene[all.markers.before$p_val_adj<0.05])
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'DEGs', ncol = 1, nrow = 1)
ggsave(sprintf('%soverlap_of_Significantly_deg(pred_labels).pdf', result_path), width = 10, height = 7)
for (each in list.files('./')){
      if (substring(each, nchar(each)-2) == 'log'){
        file.remove(each)
      }
}
```

```{r}
library(pheatmap)

colors<-colorRampPalette(c("blue","black","yellow"))(256)


features = unique(all.markers.before$gene[all.markers.before$p_val_adj<0.05])
# cells = Cells(pbmc)
data = pbmc@assays[["RNA"]]@data[features, ]
data = t(scale(t(as.matrix(data))))
data[data > 2.5] = 2.5
data[data < -2.5] = -2.5
# 构建列注释信息
annotation_col = data.frame(
  responsive = pbmc$Conditions,
  pred_labels = pbmc$pred_labels
)
rownames(annotation_col) = Cells(pbmc)
# annotation_col = annotation_col[cells, ]
head(annotation_col)

# annotation_col = annotation_col %>% arrange(factor(pred_labels, levels=c("Responder","Rejected","Non-responder")),  group.by=pred_labels)
annotation_col = annotation_col %>% arrange(factor(responsive, levels=c("Responder","Non-responder")),  group.by=responsive)
data <- data[ , rownames(annotation_col)]
ann_colors=list(
  pred_labels=c("Non-responder"="orange", "Rejected"="black","Responder"="blue"),
  responsive=c("Non-responder"="orange", "Responder"="blue")
)
heatmap3 <- pheatmap(data, annotation_col = annotation_col, annotation_colors=ann_colors, show_rownames=F, show_colnames=F, cluster_rows = T, cluster_cols = F, color=colors)
save_pheatmap_pdf(heatmap3, paste(result_path,  "heatmap_of_markers.pdf", sep=''))


##########################################################################
## after selected
##########################################################################
features = unique(all.markers.after$gene[all.markers.after$p_val_adj<0.05])
# cells = Cells(pbmc)
data = pbmc_selected@assays[["RNA"]]@data[features, ]
data = t(scale(t(as.matrix(data))))
data[data > 2.5] = 2.5
data[data < -2.5] = -2.5
# 构建列注释信息
annotation_col = data.frame(
  responsive = pbmc_selected$Conditions,
  pred_labels = pbmc_selected$pred_labels
)
rownames(annotation_col) = Cells(pbmc_selected)
# annotation_col = annotation_col[cells, ]
head(annotation_col)
# annotation_col = annotation_col %>% arrange(factor(responsive, levels=c("Responder","Non-responder")),  group.by=responsive)
annotation_col = annotation_col %>% arrange(factor(pred_labels, levels=c("Responder","Non-responder")),  group.by=pred_labels)
data <- data[ , rownames(annotation_col)]
ann_colors=list(
  pred_labels=c("Non-responder"="orange", "Responder"="blue"),
  responsive=c("Non-responder"="orange", "Responder"="blue")
)
heatmap4 <- pheatmap(data, annotation_col = annotation_col, annotation_colors=ann_colors, show_rownames=F, show_colnames=F, cluster_rows = T, cluster_cols = F, color=colors, scale='none')
save_pheatmap_pdf(heatmap4, paste(result_path,  "heatmap_of_markers_of_confidence.pdf", sep=''))
```
# count labels in patients
```{r}
patient_info <- readRDS('Feldman_cell_patient_info.rds')
patient_ID <- patient_info$`characteristics: patinet ID (Pre=baseline; Post= on treatment)`
patient_ID <- data.frame(patient_ID)
row.names(patient_ID) <- patient_info$title

pbmc <- AddMetaData(pbmc, metadata = patient_ID)
pbmc$patient_ID <- factor(pbmc$patient_ID)

ggplot(data = pbmc@meta.data, mapping = aes(x = patient_ID, fill = pred_labels)) + geom_bar(width = 0.5, position='dodge') + coord_flip() + scale_fill_manual(values = pal)
ggsave(sprintf('%spred_labels_count_in_patients.pdf', result_path), width = 7, height = 10)


ggplot(data = pbmc[, pbmc$confidence.score>0]@meta.data, mapping = aes(x = patient_ID, fill = pred_labels)) + geom_bar(width = 0.5, position='dodge') + facet_grid(~Conditions) +   scale_fill_manual(values = pal[2:3]) 

ggplot(data = pbmc@meta.data, mapping = aes(x=patient_ID, fill = pred_labels)) + geom_bar( position='stack') + facet_grid(~Conditions, scales="free_x") + scale_fill_manual(values = pal)+ theme(axis.text.x = element_text(angle = 60))

# library(ggplot2)
# 
# p1 <- ggplot(data1_SE,aes(x = addin,y = Ratio))+
#   geom_bar(stat="identity",width = 0.6,fill = "red")+
#   geom_errorbar(data = data1_SE,aes(ymin = Ratio - se, ymax = Ratio + se),width = 0.2,size = 1.5)+
#   geom_point(data = data1,aes(x = addin,y = Ratio),stat="identity",size = 3,alpha=0.5)+
#   theme(panel.background = element_blank(),
#         panel.grid = element_blank(), 
#         axis.line = element_line(colour = "#000000",size = 2),
#         axis.text = element_text(colour = "#000000" ,size = 27),
#         axis.text.x = element_text(angle = 30,vjust = 0.85,hjust = 0.75), ##就是这里
#         axis.ticks = element_line(colour = "#000000" ,size = 2) ,
#         axis.ticks.length = unit(2,'mm'),
#         plot.margin = unit(c(0.5,0,0,0),"cm"),
#         axis.title.y = element_text(size = 27),
#         axis.title.x = element_blank(),
#         plot.title = element_text(hjust = 0.5),
#         legend.position = "none")+
#   scale_y_continuous(limits = c(0,100),breaks = seq(0,100,20),expand = c(0, 0))+
#   scale_x_discrete(labels = c("1.34e+7","6.70e+7","3.35e+8"))+
#   ylab("Ratio(%)")
# 
# p1
```

# valid model on another data
```{r}
# exp_data = pbmc@assays[["RNA"]]@scale.data[VariableFeatures(pbmc),]
# exp_data = pbmc@assays[["RNA"]]@scale.data[VariableFeatures(pbmc),]
pbmc.new <- NormalizeData(object=pbmc.new, normalization.method="LogNormalize")
exp_data.new = as.matrix(pbmc.new@assays[["RNA"]]@data[VariableFeatures(pbmc),])
# exp_data_scale_t.new = scale(t(exp_data.new))
exp_data_scale_t.new = scale(t(exp_data.new), center=center, scale=scale)
exp_data.new <- t(exp_data_scale_t.new)
# write.csv(exp_data, file=paste(filepath, 'exp_data.csv', sep = ''))

emd.new = pbmc.new@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste(filepath, 'embedding-umap.new.csv', sep = ''))

dim(exp_data.new)
exp_data_new <- exp_data.new

#################################################################################
#################################################################################
VariableFeatures(pbmc.new) <- VariableFeatures(pbmc)
pbmc.new <- ScaleData(object=pbmc.new)
# pbmc.new@assays[["RNA"]]@scale.data <-exp_data_new

pbmc.new <- RunPCA(object=pbmc.new, features=VariableFeatures(pbmc.new))
pbmc.new <- FindNeighbors(object=pbmc.new, dims=1:10, k.param=20)
pbmc.new <- FindClusters(object=pbmc.new, resolution=1.6)
#data <- RunTSNE(object=data, dims=1:10)
pbmc.new <- RunUMAP(object=pbmc.new, dims=1:10)
DimPlot(object=pbmc.new, reduction='umap', label=T, label.size=10)

```

#pred on new data
```{python}
data_new = deepcopy(r.exp_data_new.T)
# embedding_name = 'embedding-umap.new'
# embedding_file = '%s/%s.csv' % (r.data_path, embedding_name)
pred_new, confidence_new = pencil.transform(data_new)
```

# Add the prediction result on new data 
```{r}
# DimPlot(object=pbmc, reduction='umap', label=T, group.by="Conditions")

pred_labels <- class_names[(py$pred_new+1)]
pbmc.new <- AddMetaData(pbmc.new, metadata = factor(pred_labels, levels = as.character(class_names)), col.name='pred_labels_without_rej')
# pred_labels <- factor(pred_labels, levels = c('Rejected', class_names))

pred_labels[py$confidence_new < 0] = 'Rejected'

pred_labels_names = c('Rejected', as.character(class_names))
pred_labels <- factor(pred_labels, levels = pred_labels_names)

pred_labels <- as.data.frame(pred_labels, row.names=colnames(pbmc.new))
pbmc.new <- AddMetaData(pbmc.new, metadata = pred_labels, col.name='pred_labels')
pal = c('gray', hue_pal()(length(class_names)))

DimPlot(object=pbmc.new, reduction='umap', label=T, group.by="pred_labels_without_rej", pt.size = 1)
DimPlot(object=pbmc.new, reduction='umap', label=T, group.by="pred_labels", cols = pal, pt.size = 1)
ggsave(paste(result_path, 'pencil_predict_labels_new.pdf'), width = 8, height = 5)

confidence <- as.data.frame(py$confidence_new, row.names=colnames(pbmc.new))
pbmc.new <- AddMetaData(pbmc.new, metadata = confidence, col.name='confidence.score' )
FeaturePlot(pbmc.new, features = 'confidence.score', pt.size = 1)
ggsave(paste(result_path, 'confidence.score_new.pdf'), width = 8, height = 5)

save(pbmc.new, pencil_weights_of_mvg2000, file= paste(result_path, 'Seurat_object_with_results_new.RData', sep=''))


table(pbmc.new$Conditions, pbmc.new$pred_labels)
table(pbmc.new$Conditions, pbmc.new$pred_labels_without_rej)

responder_sample_ids = c("11025-26_progression", "11025-57", "11025-58")
table(pbmc$patient_ID, pbmc.new$pred_labels)
```

### selected genes on new data
```{r}
select_genes = VariableFeatures(pbmc)[abs(py$w) > 1]

pbmc.raw <- pbmc
pbmc <- pbmc.new
pbmc_small.3 <- pbmc[select_genes, ]

# pbmc_small.3 <- ScaleData(object=pbmc_small.3)
pbmc_small.3 <- RunPCA(object=pbmc_small.3, features=rownames(pbmc_small.3), npcs=30)
ElbowPlot(pbmc_small.3, 30)


pbmc_small.3 <- FindNeighbors(object=pbmc_small.3, dims=1:10, k.param=20)
pbmc_small.3 <- FindClusters(object=pbmc_small.3, resolution=0.8)

# data <- RunTSNE(object=data, dims=1:10)
pbmc_small.3 <- RunUMAP(object=pbmc_small.3, dims=1:10)
# pbmc_small.3 <- RunUMAP(object=pbmc_small.3, features = select_genes)
# pbmc_small.2 <- RunTSNE(object=pbmc_small.2, dims=1:15)

A = DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="pred_labels_without_rej")
pal = c('gray', hue_pal()(length(class_names)))
B = DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="pred_labels", cols=pal, order = rev(levels(pbmc_small.3$pred_labels)))
C = DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="seurat_clusters")
D = FeaturePlot(pbmc_small.3, features = 'confidence.score', reduction='umap')

(A+B) / (C+D)
ggsave(paste(result_path, 'selected_genes_new.pdf'), width = 15, height = 12)

DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="pred_labels", cols=pal, order = rev(levels(pbmc_small.3$pred_labels)), pt.size = 1)
ggsave(paste(result_path, 'selected_genes_with_rej_cells_new.pdf'), width = 7, height = 7)



DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="pred_labels_without_rej", cells=colnames(pbmc)[pbmc$confidence.score>0], pt.size = 1)
ggsave(paste(result_path, 'selected_genes_without_rej_cells_new.pdf'), width = 7, height = 7)

# DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="original_clustering")
# DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="orig.ident")
FeaturePlot(pbmc_small.3, features = 'confidence.score', reduction='umap', pt.size = 1)
DimPlot(object=pbmc_small.3, reduction='umap', label=F, split.by='Conditions', group.by = 'pred_labels', cols=pal, pt.size=1)

DimPlot(object=pbmc_small.3, reduction='umap', label=F, group.by='Conditions', cols=pal[2:3], pt.size=1)
DimPlot(object=pbmc_small.3, reduction='umap', label=F, group.by='Conditions', cols=pal[2:3], pt.size=1, cells=colnames(pbmc_small.3)[pbmc_small.3$confidence.score>0])


pbmc.raw -> pbmc
```
# ```{r}
# # pbmc.merge <- FindVariableFeatures(object=pbmc.merge, selection.method='vst', nfeatures=2000)
# pbmc.merge <-merge(pbmc, pbmc.new)
# # pbmc.merge <- NormalizeData(object=pbmc.merge, normalization.method="LogNormalize")
# 
# # select_genes <- VariableFeatures(pbmc)
# select_genes = VariableFeatures(pbmc)[abs(py$w) > 1]
# VariableFeatures(pbmc.merge) <- select_genes
# # pbmc.merge <- ScaleData(object=pbmc.merge)
# 
# exp_data_scale = cbind(exp_data, exp_data_new)
# pbmc.merge@assays[["RNA"]]@scale.data <- exp_data_scale[select_genes, colnames(pbmc.merge)]
# 
# #
# pbmc.merge <- RunPCA(object=pbmc.merge, features=VariableFeatures(pbmc.merge))
# pbmc.merge <- FindNeighbors(object=pbmc.merge, dims=1:10, k.param=20)
# pbmc.merge <- FindClusters(object=pbmc.merge, resolution=1.6)
# #data <- RunTSNE(object=data, dims=1:10)
# pbmc.merge <- RunUMAP(object=pbmc.merge, dims=1:10)
# 
# pbmc.merge$Conditions <-pbmc.merge$responsive_status
# DimPlot(object=pbmc.merge, reduction='umap', label=F, group.by='Conditions')
# DimPlot(object=pbmc.merge, reduction='umap', label=T, group.by = 'source')
# DimPlot(object=pbmc.merge, reduction='umap', label=T, group.by = 'pred_labels', cols = pal)
# ```

# validation analysis
```{r}
library(VennDiagram)
library(grid)
library(cowplot)

DimPlot(object=pbmc_small.3, reduction='umap', label=T, group.by="Conditions", cols=pal[2:3], order = rev(levels(pbmc_small.3$pred_labels)), pt.size = 1, split.by = "pred_labels")

All_genes = rownames(pbmc)
features_for_calculation = setdiff(All_genes,All_genes[c(grep('^RPL', All_genes),grep('^RPS', All_genes),grep('\\.', All_genes),grep('^MT', All_genes))])

log2FC_cutoff = 0.05
Patient_R_vs_NR_DEGs = FindMarkers(pbmc, ident.1="Responder", ident.2="Non-responder",group.by = "Conditions",logfc.threshold=log2FC_cutoff,features = features_for_calculation)
Patient_R_vs_NR_DEGs.new = FindMarkers(pbmc.new, ident.1="Responder", ident.2="Non-responder", group.by = "Conditions",logfc.threshold=log2FC_cutoff,features = features_for_calculation)


# Patient_R_vs_NR_DEGs$genes <- row.names(Patient_R_vs_NR_DEGs)
  
##up-genes
Patient_R_NR_up_genes = rownames(Patient_R_vs_NR_DEGs %>% filter(p_val_adj<0.05 & avg_log2FC>0))
Patient_R_NR_up_genes.new = rownames(Patient_R_vs_NR_DEGs.new %>% filter(p_val_adj<0.05 & avg_log2FC>0))

##Down genes
Patient_R_NR_down_genes = rownames(Patient_R_vs_NR_DEGs %>% filter(p_val_adj<0.05 & avg_log2FC<0))
Patient_R_NR_down_genes.new = rownames(Patient_R_vs_NR_DEGs.new %>% filter(p_val_adj<0.05 & avg_log2FC<0))

venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_up_DEGs" = Patient_R_NR_up_genes,
        "Patient_R_vs_NR_up_DEGs.new" = Patient_R_NR_up_genes.new
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'up.DEGs', ncol = 1, nrow = 1)

venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_down_DEGs" = Patient_R_NR_down_genes,
        "Patient_R_vs_NR_down_DEGs.new" = Patient_R_NR_down_genes.new
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'down.DEGs', ncol = 1, nrow = 1)

venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_up_DEGs" = Patient_R_NR_up_genes,
        "Patient_R_vs_NR_down_DEGs.new" = Patient_R_NR_down_genes.new
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'up.vs.down.DEGs', ncol = 1, nrow = 1)

venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_down_DEGs" = Patient_R_NR_down_genes,
        "Patient_R_vs_NR_up_DEGs.new" = Patient_R_NR_up_genes.new
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'down.vs.up.DEGs', ncol = 1, nrow = 1)


for (each in list.files('./')){
      if (substring(each, nchar(each)-2) == 'log'){
        file.remove(each)
      }
}


common_degs =c(intersect(Patient_R_NR_up_genes, Patient_R_NR_up_genes.new), intersect(Patient_R_NR_down_genes, Patient_R_NR_down_genes.new))

pbmc <- ScaleData(object=pbmc, features = common_degs)
pbmc.new <- ScaleData(object=pbmc.new, features = common_degs)
DoHeatmap(pbmc, features = common_degs, group.by = 'Conditions', label=F)
DoHeatmap(pbmc.new, features = common_degs, group.by = 'Conditions', label=F)


pbmc <- RunPCA(object=pbmc, features=common_degs)
pbmc <- FindNeighbors(object=pbmc, dims=1:10, k.param=20)
pbmc <- FindClusters(object=pbmc, resolution=1.0)
pbmc <- RunUMAP(object=pbmc, dims=1:10)


pbmc.new <- RunPCA(object=pbmc.new, features=common_degs)
pbmc.new <- FindNeighbors(object=pbmc.new, dims=1:10, k.param=20)
pbmc.new <- FindClusters(object=pbmc.new, resolution=1.0)
pbmc.new <- RunUMAP(object=pbmc.new, dims=1:10)

DimPlot(object=pbmc, reduction='umap', label=F, group.by='Conditions', pt.size = 1)
DimPlot(object=pbmc.new, reduction='umap', label=F, group.by='Conditions', pt.size = 1)

venn.plot <- venn.diagram(
    x = list(
        "PENCIL_select_genes" = select_genes,
        "DEG.new" = c(Patient_R_NR_up_genes.new, Patient_R_NR_down_genes.new)
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'Pencil.vs.DEG.new', ncol = 1, nrow = 1)

for (each in list.files('./')){
      if (substring(each, nchar(each)-2) == 'log'){
        file.remove(each)
      }
}

```

```{r}
venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_up_DEGs" = Patient_R_NR_up_genes,
        "Patient_R_vs_NR_up_DEGs.new" = Patient_R_NR_up_genes.new,
        "PENCIL_select_genes" = select_genes
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange", "lightgreen"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'up.DEGs', ncol = 1, nrow = 1)

venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_down_DEGs" = Patient_R_NR_down_genes,
        "Patient_R_vs_NR_down_DEGs.new" = Patient_R_NR_down_genes.new,
        "PENCIL_select_genes" = select_genes
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange", "lightgreen"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'down.DEGs', ncol = 1, nrow = 1)

venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_up_DEGs" = Patient_R_NR_up_genes,
        "Patient_R_vs_NR_down_DEGs.new" = Patient_R_NR_down_genes.new,
        "PENCIL_select_genes" = select_genes
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange", "lightgreen"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'up.vs.down.DEGs', ncol = 1, nrow = 1)

venn.plot <- venn.diagram(
    x = list(
        "Patient_R_vs_NR_down_DEGs" = Patient_R_NR_down_genes,
        "Patient_R_vs_NR_up_DEGs.new" = Patient_R_NR_up_genes.new,
        "PENCIL_select_genes" = select_genes
        
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange", "lightgreen"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'down.vs.up.DEGs', ncol = 1, nrow = 1)


venn.plot <- venn.diagram(
    x = list(
        "DEG.new" = c(Patient_R_NR_up_genes, Patient_R_NR_down_genes),
        "DEG.new" = c(Patient_R_NR_up_genes.new, Patient_R_NR_down_genes.new),
        "PENCIL_select_genes" = select_genes
        
    ),
    filename = NULL,
    col = "transparent",
    fill = c("skyblue", "orange", "lightgreen"),
    cex = 2,
    cat.cex = 1,
    rotation.degree = 0, 
    main = "",
    main.cex = 2,
    sub.cex = 1,
    alpha = 0.50,
    # cat.pos=c(9,12)
)
# grid.draw(venn.plot)
plot_grid(venn.plot, labels = 'Pencil.vs.DEG.new', ncol = 1, nrow = 1)

for (each in list.files('./')){
      if (substring(each, nchar(each)-2) == 'log'){
        file.remove(each)
      }
}
```

